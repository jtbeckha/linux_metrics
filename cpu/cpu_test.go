package cpu

import (
	"github.com/go-test/deep"
	"testing"
)

func TestParseMetrics(t *testing.T) {
	data :=
		"cpu  132507 36 19439 13804256 3717 4846 2274 0 0 0\n" +
			"cpu0 9160 0 1396 860848 353 364 654 0 0 0\n" +
			"cpu1 4609 0 542 867593 127 89 203 0 0 0\n" +
			"cpu2 10391 0 1637 860046 298 334 204 0 0 0\n" +
			"cpu3 5125 2 601 867130 174 81 62 0 0 0\n" +
			"cpu4 11098 0 1564 859509 385 238 145 0 0 0\n" +
			"cpu5 5514 0 650 866832 109 90 41 0 0 0\n" +
			"cpu6 10679 0 1591 859900 369 240 123 0 0 0\n" +
			"cpu7 5353 0 580 867038 99 74 41 0 0 0\n" +
			"cpu8 10683 0 1851 859285 439 226 145 0 0 0\n" +
			"cpu9 5641 0 885 866339 94 101 63 0 0 0\n" +
			"cpu10 11357 13 1885 858303 284 615 140 0 0 0\n" +
			"cpu11 6553 0 834 865424 174 87 56 0 0 0\n" +
			"cpu12 11572 0 1952 858392 287 228 137 0 0 0\n" +
			"cpu13 6747 2 841 865227 128 73 51 0 0 0\n" +
			"cpu14 11382 13 1870 856946 290 1933 148 0 0 0\n" +
			"cpu15 6634 0 751 865434 99 66 54 0 0 0\n" +
			"intr 14857986 44 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 38 5421 6156 5020 3151 8741 1816 4324 3032 6652 2924 6852 2528 6889 2374 4974 2331 559 0 0 905 0 0 0 0 0 0 0 240076 0 0 0 0 0 0 0 0 23702 0 0 0 0 0 0 0 1 165999 4365 87290 78118 0 0 0 0 1538 0 1690 0 770430 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\n" +
			"ctxt 31676484\n" +
			"btime 1557666783\n" +
			"processes 9821\n" +
			"procs_running 1\n" +
			"procs_blocked 0\n" +
			"softirq 5834177 5 2216538 1974 452778 1054 0 31176 1786244 71 1344337\n"

	expected := map[string]interface{}{
		"cpu.aggregate.user":       132507,
		"cpu.aggregate.nice":       36,
		"cpu.aggregate.system":     19439,
		"cpu.aggregate.idle":       13804256,
		"cpu.aggregate.iowait":     3717,
		"cpu.aggregate.irq":        4846,
		"cpu.aggregate.softirq":    2274,
		"cpu.aggregate.steal":      0,
		"cpu.aggregate.guest":      0,
		"cpu.aggregate.guest_nice": 0,
	}

	actual := ParseMetrics(data)
	diffs := deep.Equal(expected, actual)
	if len(diffs) > 0 {
		t.Errorf("ParseMetrics did not return expected result, diffs=%s", diffs)
	}
}
